---
import type { RoleId } from "../data/team";
import roleBackScriptSrc from "../scripts/role-back.ts?url";

const ROLE_LABELS: Record<RoleId, string> = {
  coder: "RUNE COMPILER",
  driver: "AETHER PILOT",
  designer: "CAD ARCHITECT",
  builder: "PNEUMATIC FORGEWRIGHT",
  notebooker: "SCRIBE OF EVIDENCE",
};

const ROLE_CLASS: Record<RoleId, string> = {
  coder: "CODER",
  driver: "DRIVER",
  designer: "DESIGNER",
  builder: "BUILDER",
  notebooker: "NOTEBOOKER",
};

const TELEMETRY: Record<RoleId, { label: string; value: string }[]> = {
  driver: [
    { label: "HEADING", value: "127 DEG" },
    { label: "TRACTION", value: "94%" },
    { label: "TIME", value: "1:45" },
    { label: "VOLT", value: "12.6V" },
  ],
  builder: [
    { label: "AIR PSI", value: "100" },
    { label: "MOTOR C", value: "38" },
    { label: "GEAR", value: "84:1" },
    { label: "TENSION", value: "OK" },
  ],
  coder: [
    { label: "P/I/D", value: "2.4/0.1/18" },
    { label: "LOOP", value: "10ms" },
    { label: "IMU", value: "0.2 DEG" },
    { label: "STATE", value: "AUTON" },
  ],
  designer: [
    { label: "CLR", value: "2.1mm" },
    { label: "MASS", value: "6.2kg" },
    { label: "CG", value: "CENTER" },
    { label: "REV", value: "v14" },
  ],
  notebooker: [
    { label: "ITERS", value: "47" },
    { label: "TESTS", value: "128" },
    { label: "RUBRIC", value: "91%" },
    { label: "Q/A", value: "READY" },
  ],
};

const { roleId = "coder", name = "" } = Astro.props as { roleId?: RoleId; name?: string };
const roleLabel = ROLE_LABELS[roleId] ?? "TEAM";
const roleClass = ROLE_CLASS[roleId] ?? "TEAM";
const telemetry = TELEMETRY[roleId] ?? [];
const telemetryKey = (label: string) =>
  label === "AIR PSI" ? "air-psi" : label === "TENSION" ? "tension" : "";

const coderLines = [
  { text: "  PID LOOP: REPLACING MATH WITH GUESSWORK", cube: true },
  { text: "  AUTON: 15 SECONDS OF PURE ANXIETY", glitch: true },
  { text: "  DEPLOYING CODE", nudge: true },
  { text: "  PREPARING APOLOGY TO DRIVERS", glitch: true },
];

const driverLines = [
  { text: "  STRATEGY: DEPENDS ON IF AUTON WORKS" },
  { text: "  GAME: VRC PUSH BACK" },
  { text: "  CURRENTLY PUSHING OUR LUCK" },
  { text: "  BATTERY: 88%" },
  { text: "  DRIVER CONFIDENCE: 12%" },
  { text: "  CONTROLLER DISCONNECTED: JUST A TRADITION " },
];

const designerLines = [
  { text: "  CONSTRAINTS: 42 ERRORS ACTIVELY IGNORED", glow: true },
  { text: "  CENTER OF MASS: SOMEWHERE OUTSIDE THE ROBOT", aura: true },
  { text: "  ASSEMBLY: IF IT CLIPS IN CAD, JUST PUSH HARDER IRL", progress: true },
  { text: "  EXPORTING: CHASSIS_FINAL_v28_PLEASE_WORK.STEP"},
];

const builderLines = [
  { text: "  FASTENERS: TORQUED UNTIL THEY STRIP, THEN BACK A QUARTER TURN" },
  { text: "  STRUCTURAL INTEGRITY: LOAD-BEARING ZIP TIES ONLINE" },
  { text: "  SPARE PARTS ON DESK: 12" },
  { text: "  IDEA WHERE THEY BELONG: 0" },
  { text: "  SAFETY GLASSES: SECURELY RESTING ON FOREHEAD", impact: true },
];

const notebookLines = [
  { text: "  EVIDENCE LOG: DOCUMENTING THE DESIGN PROCESS IN REVERSE" },
  { text: "  PROBLEM -> BUILD -> BREAK -> PRETEND WE PLANNED IT", glow: true },
  { text: "  ENTRY 128: WRITTEN IN THE CAR ON THE WAY TO TOURNAMENT" },
  { text: "  RUBRIC ALIGNMENT: HOPING THE JUDGES JUST SKIM IT", glow: true },
  { text: "  HANDWRITING DEGRADING RAPIDLY" },
  { text: "  BINDER WEIGHT: 5 LBS USEFUL INFO: 2 PAGES", glow: true},
  { text: "  SEND COFFEE" ,glow: true, final: true  },
];

const runeGlyphs = ["\u2726", "\u29bf", "\u2234", "\u03a9", "\u2609", "\u2727"];
---

<div class={`role-back role-${roleId}`} data-role={roleId}>
  <div class="arcana-header">
    <div class="arcana-hud" aria-hidden="true">
      <span class="arcana-hud__corner arcana-hud__corner--tl"></span>
      <span class="arcana-hud__corner arcana-hud__corner--tr"></span>
      <div class="arcana-hud__labels">
        <span>MODULE: ACTIVE</span>
        <span>FIELD LINK: ONLINE</span>
        <span>ARCANA: SYNCED</span>
        <span>CLASS: {roleClass}</span>
      </div>
    </div>
    <div class="role-nameplate" aria-hidden="true">
      <p class="role-nameplate__name">{name || "Team Sigma"}</p>
      <p class="role-nameplate__role">{roleLabel}</p>
    </div>
  </div>

  <div class="role-viewport">
    <div class="arcana-portal" aria-hidden="true">
      <div class="arcana-portal__scanline"></div>
      <div class="arcana-portal__sigil" data-arcana-sigil>\u29bf</div>
    </div>
    <div class="arcana-sheen" aria-hidden="true"></div>
    <div class="arcana-proc" aria-hidden="true">LEGENDARY PROC</div>

    {roleId === "coder" && (
      <div class="role-scene coder-scene">
        <div class="coder-matrix" data-matrix aria-hidden="true"></div>
        <div class="coder-noise" aria-hidden="true"></div>
        <div class="coder-cube" aria-hidden="true"></div>
        <div class="coder-bootlog" data-coder-boot aria-hidden="true"></div>
      </div>
    )}

    {roleId === "driver" && (
      <div class="role-scene driver-scene">
        <div class="driver-viewport" data-driver aria-hidden="true">
          <div class="driver-viewport__grid"></div>
          <div class="driver-viewport__halo"></div>
        </div>
      </div>
    )}

    {roleId === "designer" && (
      <div class="role-scene designer-scene">
        <div class="designer-blueprint" aria-hidden="true">
          <div class="designer-viewport" data-designer aria-hidden="true"></div>
          <svg viewBox="0 0 200 140" class="designer-svg">
            <rect class="blueprint-outline" x="26" y="28" width="120" height="70" rx="8" data-blueprint-line></rect>
            <path class="blueprint-extrude" d="M60 98 L100 120 L160 82 L120 60 Z" data-blueprint-line></path>
            <circle class="blueprint-circle" cx="90" cy="64" r="14" data-blueprint-line></circle>
            <path class="blueprint-dimension" d="M36 20 L36 114 M36 20 L28 28 M36 20 L44 28 M36 114 L28 106 M36 114 L44 106" data-blueprint-line></path>
          </svg>
          <div class="designer-constraints">
            <span>PERP</span>
            <span>LOCK</span>
            <span>TRI</span>
            <span>DIA</span>
          </div>
        </div>
      </div>
    )}

    {roleId === "builder" && (
      <div class="role-scene builder-scene">
        <div class="builder-canvas" data-builder aria-hidden="true"></div>
      </div>
    )}

    {roleId === "notebooker" && (
      <div class="role-scene notebook-scene">
        <div class="notebook-scroll">
          <div class="notebook-scroll__glow" aria-hidden="true"></div>
          <div class="notebook-scroll__paper" data-scroll>
            <div class="notebook-scroll__cap notebook-scroll__cap--top" aria-hidden="true"></div>
            <div class="notebook-scroll__cap notebook-scroll__cap--bottom" aria-hidden="true"></div>
            <div class="notebook-scroll__inkblot" data-inkblot aria-hidden="true"></div>
            <div class="notebook-scroll__grid" aria-hidden="true"></div>
            <div class="notebook-scroll__circuit" aria-hidden="true"></div>
            <div class="notebook-ghostpage" aria-hidden="true"></div>
            <div class="notebook-judge" aria-hidden="true"></div>
            <div class="notebook-timeline" aria-hidden="true">
              <span class="notebook-timeline__trace"></span>
              <span class="notebook-timeline__mark">WORLDS</span>
            </div>
          </div>
        </div>
        <div class="notebook-runes" aria-hidden="true">
          {runeGlyphs.map((glyph, index) => (
            <span class="notebook-rune" style={`--delay:${index * 0.24}s; --x:${10 + ((index * 17) % 80)}%; --travel:${45 + (index % 3) * 15}%;`}>
              {glyph}
            </span>
          ))}
        </div>
      </div>
    )}
  </div>

  {roleId === "coder" && (
    <div class="pixel-terminal coder-terminal" data-typewriter="coder">
      <div class="prompt cli-cursor">sigma@matrix:~$</div>
      {coderLines.map((line) => (
        <p class="terminal-line" data-line data-text={line.text} data-cube={line.cube ? "1" : undefined} data-glitch={line.glitch ? "1" : undefined} data-nudge={line.nudge ? "1" : undefined}></p>
      ))}
    </div>
  )}

  {roleId === "driver" && (
    <div class="pixel-terminal driver-cli" data-typewriter="driver">
      <div class="prompt cli-cursor">driver@pushback:~$</div>
      {driverLines.map((line) => (
        <p class="terminal-line" data-line data-text={line.text}></p>
      ))}
    </div>
  )}

  {roleId === "designer" && (
    <div class="pixel-terminal designer-terminal" data-typewriter="designer">
      <div class="prompt cli-cursor">designer@cad:~$</div>
      <div class="designer-progress" aria-hidden="true">
        <span class="designer-progress__fill"></span>
      </div>
      {designerLines.map((line, index) => (
        <p class="terminal-line designer-line" style={`--line-index:${index};`} data-line data-text={line.text} data-blueprint-glow={line.glow ? "1" : undefined} data-blueprint-aura={line.aura ? "1" : undefined} data-blueprint-progress={line.progress ? "1" : undefined}></p>
      ))}
      <div class="designer-toast" aria-hidden="true">saving...</div>
    </div>
  )}

  {roleId === "builder" && (
    <div class="pixel-terminal builder-terminal" data-typewriter="builder">
      <div class="prompt cli-cursor">builder@pit:~$</div>
      {builderLines.map((line) => (
        <p class="terminal-line" data-line data-text={line.text} data-impact={line.impact ? "1" : undefined}></p>
      ))}
    </div>
  )}

  {roleId === "notebooker" && (
    <div class="pixel-terminal notebook-terminal" data-typewriter="notebook">
      <div class="prompt cli-cursor">notebook@chronicle:~$</div>
      {notebookLines.map((line) => (
        <p class="terminal-line" data-line data-text={line.text} data-glow={line.glow ? "1" : undefined} data-final={line.final ? "1" : undefined}></p>
      ))}
      <span class="cursor-block" data-cursor aria-hidden="true"></span>
    </div>
  )}

  <div class="arcana-telemetry" aria-hidden="true">
    {telemetry.map((t) => (
      <div class="arcana-telemetry__item">
        <span class="arcana-telemetry__label">{t.label}</span>
        <span class="arcana-telemetry__value" data-telemetry-value={telemetryKey(t.label) || undefined}>{t.value}</span>
      </div>
    ))}
  </div>
</div>

<style>
  .role-back {
    --viewport-h: clamp(200px, 58cqi, 320px);
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 0;
    box-sizing: border-box;
    container-type: inline-size;
    border-radius: 1.25rem;
    font-family: "Press Start 2P", system-ui, sans-serif;
    font-size: 0.54rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #f8fafc;
    border: 1px solid color-mix(in srgb, var(--role-accent, #64d9ff) 45%, rgba(255, 255, 255, 0.1));
    background:
      radial-gradient(circle at 45% -10%, color-mix(in srgb, var(--role-accent, #64d9ff) 35%, transparent), transparent 60%),
      radial-gradient(circle at 50% 120%, rgba(3, 7, 18, 0.95), rgba(0, 0, 0, 0.95));
    box-shadow: inset 0 0 65px rgba(0, 0, 0, 0.65), 0 0 65px color-mix(in srgb, var(--role-accent, #64d9ff) 25%, transparent);
  }

  .role-back.role-designer { --viewport-h: clamp(240px, 66cqi, 360px); }
  .role-back.role-driver, .role-back.role-builder { --viewport-h: clamp(210px, 60cqi, 340px); }

  .arcana-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; padding: 0.45rem 0.55rem 0.25rem; flex: 0 0 auto; }
  .arcana-hud__labels { display: flex; flex-wrap: wrap; gap: 0.25rem 0.45rem; font-family: "JetBrains Mono", monospace; font-size: 0.42rem; letter-spacing: 0.08em; color: color-mix(in srgb, var(--role-accent, #5cf6ff) 55%, rgba(255, 255, 255, 0.4)); }
  .role-nameplate { padding: 0.32rem 0.5rem 0.24rem; border-radius: 0.45rem; background: rgba(0, 0, 0, 0.55); border: 1px solid color-mix(in srgb, var(--role-accent, #64d9ff) 50%, rgba(255, 255, 255, 0.25)); text-align: right; flex-shrink: 0; }
  .role-nameplate__name { margin: 0; font-size: 0.5rem; line-height: 1.25; }
  .role-nameplate__role { margin: 0.1rem 0 0; font-size: 0.42rem; color: color-mix(in srgb, var(--role-accent, #64d9ff) 65%, #fff); }

  .role-viewport { position: relative; flex: 0 0 var(--viewport-h); min-height: 0; margin: 0.12rem 0.45rem 0; border-radius: 0.95rem; border: 1px solid color-mix(in srgb, var(--role-accent, #64d9ff) 30%, rgba(255, 255, 255, 0.08)); background: rgba(2, 6, 18, 0.88); overflow: hidden; isolation: isolate; }
  .role-scene { position: relative; z-index: 1; display: flex; width: 100%; height: 100%; min-height: 0; overflow: hidden; }
  .arcana-portal, .arcana-sheen { position: absolute; inset: 0; pointer-events: none; }
  .arcana-portal { z-index: 14; opacity: 0; }
  .role-back.is-revealing .arcana-portal { opacity: 1; }
  .arcana-sheen { z-index: 13; opacity: 0; transition: opacity 0.4s ease 0.6s; background: linear-gradient(135deg, transparent 38%, rgba(255, 255, 255, 0.08) 50%, transparent 62%); }
  .role-back.is-active .arcana-sheen { opacity: 1; }
  .arcana-proc { position: absolute; right: 0.5rem; bottom: 0.45rem; z-index: 15; padding: 0.2rem 0.4rem; border-radius: 0.35rem; font-size: 0.4rem; border: 1px solid color-mix(in srgb, var(--role-accent, #64d9ff) 60%, transparent); background: rgba(0, 0, 0, 0.6); color: var(--role-accent, #64d9ff); opacity: 0; }

  .pixel-terminal { position: relative; flex: 1 1 auto; min-height: 0; overflow: auto; scrollbar-gutter: stable; margin: 0.24rem 0.45rem 0; padding: 0.36rem 0.5rem; border-radius: 0.75rem; background: rgba(3, 6, 18, 0.9); border: 1px solid color-mix(in srgb, var(--role-accent, #64d9ff) 42%, rgba(148, 163, 184, 0.2)); box-shadow: inset 0 0 24px rgba(0, 0, 0, 0.55); color: color-mix(in srgb, var(--role-accent, #64d9ff) 76%, rgba(255, 255, 255, 0.35)); font-size: 0.48rem; line-height: 1.28; scrollbar-width: none; -ms-overflow-style: none; }
  .pixel-terminal::-webkit-scrollbar { width: 0; height: 0; }
  .pixel-terminal .prompt { margin-bottom: 0.25rem; color: color-mix(in srgb, var(--role-accent, #64d9ff) 88%, #fff); font-size: 0.47rem; }
  .terminal-line { min-height: 0.7rem; margin: 0; font-size: 0.48rem; line-height: 1.24; opacity: 0.12; transform: translateX(4px) scale(0.98); transition: opacity 0.25s ease, transform 0.3s ease; }
  .terminal-line.is-visible { opacity: 0.84; transform: translateX(0); }
  .terminal-line.is-finished { opacity: 1; }
  .terminal-line.is-glow { color: color-mix(in srgb, var(--role-accent, #64d9ff) 88%, #fff); text-shadow: 0 0 12px color-mix(in srgb, var(--role-accent, #64d9ff) 65%, transparent); }
  .cli-cursor::after { content: "_"; display: inline-block; margin-left: 0.2em; animation: cursorBlink 0.9s steps(1) infinite; }
  .cursor-block { display: inline-block; width: 0.6rem; height: 0.8rem; background: #b9ff66; margin-left: 0.35rem; animation: cursorBlink 0.7s steps(1) infinite; }

  .arcana-telemetry { flex: 0 0 auto; display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 0.24rem; margin: 0.2rem 0.45rem 0.42rem; padding: 0.24rem 0.32rem; border-radius: 0.5rem; background: rgba(0, 0, 0, 0.5); border: 1px solid color-mix(in srgb, var(--role-accent, #5cf6ff) 30%, transparent); font-family: "JetBrains Mono", monospace; font-size: 0.38rem; line-height: 1.15; opacity: 0; transform: translateY(4px); transition: opacity 0.3s ease 0.45s, transform 0.3s ease 0.45s; }
  .role-back.is-active .arcana-telemetry { opacity: 1; transform: translateY(0); }
  .arcana-telemetry__item { display: flex; flex-direction: column; align-items: center; gap: 1px; }
  .arcana-telemetry__label { color: color-mix(in srgb, var(--role-accent, #5cf6ff) 48%, rgba(255, 255, 255, 0.35)); }
  .arcana-telemetry__value { color: var(--role-accent, #5cf6ff); font-weight: 700; }

  .coder-scene { background: radial-gradient(circle at 30% 0%, rgba(0, 255, 160, 0.2), transparent 45%), radial-gradient(circle at 70% 20%, rgba(30, 120, 255, 0.2), transparent 50%), #010504; }
  .coder-matrix, .driver-viewport, .builder-canvas { position: absolute; inset: 0; }
  .coder-noise { position: absolute; inset: 0; background-image: linear-gradient(transparent 70%, rgba(0, 0, 0, 0.45)), repeating-linear-gradient(0deg, rgba(0, 255, 170, 0.03) 0, rgba(0, 0, 0, 0.03) 2px); mix-blend-mode: screen; opacity: 0.5; }
  .coder-cube { position: absolute; inset: 18% 12% auto; height: 44%; border: 1px solid rgba(94, 234, 212, 0.3); opacity: 0; pointer-events: none; }
  .coder-bootlog { position: absolute; top: 8%; left: 8%; right: 8%; padding: 0.5rem 0.6rem; border-radius: 0.5rem; background: rgba(0, 0, 0, 0.58); border: 1px solid rgba(94, 234, 212, 0.3); font-size: 0.52rem; opacity: 0; transform: translateY(-8px); }
  .coder-terminal { border-color: color-mix(in srgb, var(--role-accent, #64d9ff) 42%, rgba(148, 163, 184, 0.2)); }

  .driver-scene { background: radial-gradient(circle at 40% -10%, rgba(2, 132, 199, 0.35), transparent 55%), radial-gradient(circle at 50% 120%, rgba(0, 0, 0, 0.8), rgba(2, 6, 18, 0.95)); }
  .driver-viewport__grid { position: absolute; inset: 0; background-image: repeating-linear-gradient(90deg, rgba(56, 189, 248, 0.15) 0 1px, transparent 1px 24px), repeating-linear-gradient(180deg, rgba(56, 189, 248, 0.12) 0 1px, transparent 1px 24px); opacity: 0.45; }
  .driver-viewport__halo { position: absolute; inset: -12%; background: radial-gradient(circle at 50% 65%, rgba(125, 211, 252, 0.25), transparent 70%); mix-blend-mode: screen; }

  .designer-scene { background: radial-gradient(circle at 20% 0%, rgba(236, 72, 153, 0.25), transparent 55%), linear-gradient(160deg, #030615, #050014); }
  .designer-blueprint { flex: 1; margin: 0.45rem; border-radius: 0.8rem; border: 1px solid rgba(59, 130, 246, 0.35); background: repeating-linear-gradient(to right, rgba(59, 130, 246, 0.08) 0 1px, transparent 1px 12px), repeating-linear-gradient(to bottom, rgba(59, 130, 246, 0.08) 0 1px, transparent 1px 12px), radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.28), transparent 55%); position: relative; overflow: hidden; }
  .designer-blueprint::before { content: ""; position: absolute; inset: -20% -10%; z-index: 1; pointer-events: none; background: linear-gradient(120deg, transparent 28%, rgba(236, 72, 153, 0.12) 48%, transparent 70%); opacity: 0.75; transform: translateX(-60%); }
  .role-back.is-active .designer-blueprint::before { animation: designerSheen 3.8s linear infinite; }
  .designer-viewport { position: absolute; inset: 0; z-index: 1; pointer-events: none; }
  .designer-svg { position: absolute; inset: 0; z-index: 2; width: 100%; height: 100%; fill: none; }
  .designer-svg [data-blueprint-line] { stroke: rgba(147, 197, 253, 0.86); stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; vector-effect: non-scaling-stroke; }
  .designer-constraints { position: absolute; inset: 0.75rem; z-index: 3; display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.4rem; font-size: 0.5rem; color: rgba(148, 197, 255, 0.7); }
  .designer-constraints span { transition: transform 0.25s ease, opacity 0.25s ease; }
  .designer-glyphforge-canvas { mix-blend-mode: screen; opacity: 0.92; }
  .designer-progress { position: relative; width: 100%; height: 6px; border-radius: 999px; background: rgba(59, 130, 246, 0.15); overflow: hidden; margin: 0.35rem 0 0.7rem; opacity: 0; transform: translateY(-6px); transition: opacity 0.35s ease, transform 0.35s ease; }
  .designer-progress__fill { position: absolute; inset: 0; width: 0%; background: linear-gradient(90deg, rgba(59, 130, 246, 0.9), rgba(236, 72, 153, 0.85)); }
  .designer-toast { margin-top: 0.35rem; width: fit-content; padding: 0.25rem 0.55rem; border-radius: 0.45rem; background: rgba(5, 6, 24, 0.85); border: 1px solid rgba(236, 72, 153, 0.55); font-size: 0.5rem; opacity: 0; transform: translateY(6px); }

  .builder-scene { background: radial-gradient(circle at 30% -10%, rgba(251, 191, 36, 0.3), transparent 55%), radial-gradient(circle at 60% 50%, rgba(88, 28, 135, 0.35), rgba(10, 8, 24, 0.95)); }
  .notebook-scene { background: radial-gradient(circle at 50% 10%, rgba(190, 255, 255, 0.22), transparent 60%), linear-gradient(180deg, #070d22, #020408 70%, #010102); }
  .notebook-scroll { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; padding: 0.35rem; overflow: hidden; }
  .notebook-scroll__glow { position: absolute; inset: 0; background: radial-gradient(circle at 40% 30%, rgba(250, 250, 210, 0.35), transparent 60%), radial-gradient(circle at 70% 60%, rgba(190, 242, 255, 0.3), transparent 65%); filter: blur(28px); }
  .notebook-scroll__paper { position: relative; width: 100%; height: 100%; border-radius: 0.9rem; border: 1px solid rgba(254, 240, 138, 0.4); background: linear-gradient(180deg, rgba(19, 32, 68, 0.85), rgba(6, 11, 28, 0.95)); transform-origin: center; transform: scaleY(0.06); clip-path: inset(52% 0 52% 0 round 0.9rem); filter: blur(10px); overflow: hidden; transition: transform 0.9s cubic-bezier(0.23, 1, 0.32, 1), filter 0.6s ease, clip-path 0.9s cubic-bezier(0.23, 1, 0.32, 1); }
  .role-back.is-scroll-ready .notebook-scroll__paper { transform: scaleY(1); filter: blur(0); clip-path: inset(0 0 0 0 round 0.9rem); }
  .notebook-scroll__cap { position: absolute; left: 50%; width: 72%; height: 20px; border-radius: 999px; background: radial-gradient(circle at 50% 50%, rgba(254, 240, 138, 0.85), rgba(2, 6, 23, 0.85)); z-index: 3; opacity: 0; transform: translate(-50%, -120%) scaleY(0.25); transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.45s ease; }
  .notebook-scroll__cap--top { top: -10px; }
  .notebook-scroll__cap--bottom { bottom: -10px; transform: translate(-50%, 120%) scaleY(0.25); }
  .notebook-scroll__inkblot { position: absolute; inset: 0.38rem; border-radius: 1rem; overflow: hidden; opacity: 0; z-index: 0; transition: opacity 0.6s ease; }
  .role-back.is-scroll-ready .notebook-scroll__inkblot { opacity: 1; }
  .notebook-scroll__grid, .notebook-scroll__circuit, .notebook-ghostpage, .notebook-judge, .notebook-timeline { position: absolute; }
  .notebook-runes { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
  .notebook-rune { position: absolute; left: var(--x, 50%); bottom: -10%; font-size: 0.6rem; color: rgba(248, 247, 248, 0.4); animation: runeRise 7s linear infinite; animation-delay: var(--delay, 0s); opacity: 0; }

  .role-back.is-revealing .arcana-proc { opacity: 1; animation: procPulse 0.7s ease-out; }
  .coder-cube.is-active { opacity: 1; animation: coderPulse 1.05s ease-out; }
  .coder-bootlog.is-visible { opacity: 1; transform: translateY(0); transition: opacity 0.25s ease, transform 0.25s ease; }
  .coder-terminal.is-sliding { animation: coderSlide 1.05s cubic-bezier(0.25, 1, 0.4, 1); }
  .coder-terminal.is-nudge { animation: coderNudge 0.45s ease-out; }
  .coder-scene.is-blackout { animation: coderBlackout 0.2s steps(1) forwards; }
  .coder-scene.is-crt { animation: coderCrt 0.85s ease-out; }
  .coder-matrix.is-storm { animation: coderStorm 1.2s linear; }
  .coder-matrix.is-glitching { animation: coderGlitch 0.8s steps(2) forwards; }

  .designer-progress.is-active { opacity: 1; transform: translateY(0); }
  .designer-progress.is-active .designer-progress__fill { animation: designerProgress 1.1s ease-out forwards; }
  .designer-toast.is-visible { opacity: 1; transform: translateY(0); transition: opacity 0.3s ease, transform 0.3s ease; }
  .designer-blueprint.is-validated { box-shadow: inset 0 0 40px rgba(59, 130, 246, 0.22), 0 0 24px rgba(34, 197, 235, 0.25); }
  .designer-blueprint.is-aura { filter: saturate(1.25); }
  .designer-blueprint.is-tilt { transform: perspective(900px) rotateX(6deg) rotateY(-5deg) scale(1.02); }

  .builder-scene.is-bpm,
  .builder-scene.is-quake { animation: builderBpm 0.85s ease-out; }

  .notebook-scroll__cap--top.is-contract { transform: translate(-50%, -55%) scaleY(1.08); }
  .notebook-scroll__cap--bottom.is-contract { transform: translate(-50%, 55%) scaleY(1.08); }
  .role-back.is-scroll-ready .notebook-scroll__cap--top { opacity: 1; transform: translate(-50%, -55%) scaleY(1); }
  .role-back.is-scroll-ready .notebook-scroll__cap--bottom { opacity: 1; transform: translate(-50%, 55%) scaleY(1); }
  .notebook-ghostpage.is-active { animation: notebookGhost 1.3s ease-out; }
  .notebook-judge.is-active { animation: notebookJudge 1.1s ease-out; }
  .notebook-timeline.is-tracing { opacity: 1; transform: translateY(0); transition: opacity 0.25s ease, transform 0.25s ease; }
  .notebook-timeline.is-tracing .notebook-timeline__trace { animation: notebookTrace 1.6s ease-out forwards; }
  .notebook-terminal::before { content: \"\"; position: absolute; left: 0.35rem; right: 0.35rem; top: 0.8rem; height: 2px; background: linear-gradient(90deg, transparent, rgba(250, 204, 21, 0.7), transparent); opacity: 0; }
  .role-back.is-scroll-ready .notebook-terminal::before { opacity: 0.75; animation: prophecyScan 7s linear infinite; }
  .notebook-terminal.is-final .terminal-line:not(.is-final-line) { opacity: 0.35; }

  @keyframes cursorBlink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }
  @keyframes procPulse { 0% { transform: scale(0.85); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
  @keyframes coderPulse { 0% { transform: translateY(-12px) scale(0.9); } 60% { transform: translateY(0) scale(1.02); } 100% { transform: translateY(6px) scale(0.96); opacity: 0; } }
  @keyframes coderSlide { 0% { transform: translateY(36px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
  @keyframes coderNudge { 0% { transform: translateX(0); } 40% { transform: translateX(6px); } 100% { transform: translateX(0); } }
  @keyframes coderBlackout { 0% { filter: brightness(0.4); } 100% { filter: brightness(1); } }
  @keyframes coderCrt { 0% { transform: scaleY(0.08); opacity: 0.4; } 100% { transform: scaleY(1); opacity: 1; } }
  @keyframes coderStorm { 0% { filter: saturate(1); } 50% { filter: saturate(1.35); } 100% { filter: saturate(1); } }
  @keyframes coderGlitch { 0% { transform: translate3d(0, 0, 0); } 50% { transform: translate3d(-2px, 1px, 0); } 100% { transform: translate3d(0, 0, 0); } }
  @keyframes designerProgress { 0% { width: 0%; } 100% { width: 100%; } }
  @keyframes designerSheen { 0% { transform: translateX(-60%); opacity: 0; } 20% { opacity: 0.7; } 100% { transform: translateX(72%); opacity: 0; } }
  @keyframes builderBpm { 0% { transform: translateY(0); } 30% { transform: translateY(-6px); } 60% { transform: translateY(4px); } 100% { transform: translateY(0); } }
  @keyframes prophecyScan { 0% { transform: translateY(-15%); } 50% { transform: translateY(115%); } 100% { transform: translateY(-15%); } }
  @keyframes notebookGhost { 0% { opacity: 0; transform: translateX(-26%); } 20% { opacity: 0.65; } 100% { opacity: 0; transform: translateX(8%); } }
  @keyframes notebookJudge { 0% { opacity: 0; transform: translateY(12px); } 40% { opacity: 0.3; } 100% { opacity: 0; transform: translateY(-6px); } }
  @keyframes notebookTrace { 0% { width: 0%; } 100% { width: 100%; } }
  @keyframes runeRise { 0% { transform: translate(-50%, 0) scale(0.9); opacity: 0; } 15% { opacity: 0.6; } 70% { opacity: 0.8; } 100% { transform: translate(-50%, calc(-1 * var(--travel, 60%))) scale(1.2); opacity: 0; } }
</style>
<script type="module" src={roleBackScriptSrc}></script>
